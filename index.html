<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>فروشگاه سنجد</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Lalezar&family=Vazirmatn:wght@300;400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #6B8E23; 
            --dark-green: #3A5210;
            --light-bg: #f8f9fa;      
            --selected-bg: #eef5e0;   
            --text-color: #444;
            --shadow: 0 10px 30px rgba(0,0,0,0.08);
            --gold-color: #FFD700;
        }

        body {
            font-family: 'Vazirmatn', sans-serif;
            margin: 0; padding: 0 0 100px 0;
            background-color: var(--light-bg);
            color: var(--text-color);
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            width: 100vw;
        }

        /* --- هدر --- */
        .header {
            position: relative;
            background: linear-gradient(135deg, #557C18 0%, #2d420b 100%);
            padding: 40px 20px 70px 20px;
            border-radius: 0 0 40px 40px;
            text-align: center; overflow: hidden;
            box-shadow: 0 10px 25px rgba(45, 66, 11, 0.3); z-index: 10;
        }
        .header-bg-icon {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 10rem; color: rgba(255,255,255,0.03); pointer-events: none;
        }
        .header h1 {
            font-family: 'Lalezar', cursive; margin: 0; font-size: 3.5rem; color: #fff;
            text-shadow: 0 4px 15px rgba(0,0,0,0.3); position: relative; z-index: 2;
            animation: fadeInDown 1s ease-out;
        }
        .header p {
            font-weight: 300; margin: 5px 0 0; 
            color: rgba(255, 255, 255, 0.85); font-size: 1rem; position: relative; z-index: 2;
            animation: fadeInUp 1s ease-out 0.3s backwards;
        }
        
        .menu-toggle-btn {
            position: absolute; top: 20px; right: 20px;
            background: none; border: none; color: white;
            font-size: 1.8rem; cursor: pointer; z-index: 20; padding: 5px;
        }

        button:focus, input:focus, .product-item:focus-within {
            outline: none;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.3);
        }

        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .container { padding: 0 20px 20px; max-width: 1200px; margin: 0 auto; }
        .search-container { position: relative; margin-top: -35px; margin-bottom: 35px; z-index: 20; }
        #search-input {
            width: 100%; padding: 18px 50px 18px 20px; font-size: 1.1rem;
            border-radius: 50px; border: none;
            background-color: #fff; box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            color: #555; box-sizing: border-box;
        }
        #search-input:focus { box-shadow: 0 15px 30px rgba(107, 142, 35, 0.25); }
        .search-icon { position: absolute; right: 25px; top: 50%; transform: translateY(-50%); color: var(--primary-color); font-size: 1.3rem; pointer-events: none; }

        /* منوی جانبی */
        .side-menu-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.3); z-index: 998;
            opacity: 0; visibility: hidden; transition: all 0.3s ease;
            backdrop-filter: blur(3px);
        }
        .side-menu {
            position: fixed; top: 0; right: -320px;
            width: 280px; height: 100%;
            background: rgba(20, 30, 10, 0.95); backdrop-filter: blur(15px);
            z-index: 999; box-shadow: -5px 0 20px rgba(0,0,0,0.2);
            padding: 20px; display: flex; flex-direction: column; color: white;
            visibility: hidden; 
            transition: right 0.4s cubic-bezier(0.19,1,0.22,1), visibility 0s linear 0.4s;
        }
        .side-menu.active { 
            right: 0; visibility: visible;
            transition: right 0.4s cubic-bezier(0.19,1,0.22,1), visibility 0s linear 0s;
        }
        .side-menu-overlay.active { opacity: 1; visibility: visible; }

        .side-menu-header {
            display: flex; justify-content: space-between; align-items: center;
            padding-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px;
        }
        .close-menu-btn { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; }
        .fav-list-container { overflow-y: auto; flex-grow: 1; max-height: 60vh; }
        .fav-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .fav-item i { color: #ff4757; cursor: pointer; padding: 5px; }

        /* --- کاشی‌ها --- */
        .categories-grid { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(150px,1fr)); gap: 18px; padding-bottom: 20px;
        }
        @media (min-width:480px) { .categories-grid { grid-template-columns: repeat(auto-fill,minmax(220px,1fr)); gap:25px; } }

        .category-tile {
            position: relative; color: white; border-radius: 25px; overflow: hidden;
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            height: 170px; padding: 10px; box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s cubic-bezier(0.25,0.8,0.25,1); cursor: pointer;
        }
        .category-tile:active { transform: scale(0.95); }
        .category-tile:hover { transform: translateY(-5px); }

        .cat-special { background: linear-gradient(135deg,#0f2027 0%,#203a43 50%,#2c5364 100%); border:1px solid rgba(255,255,255,0.1); }
        .cat-mixer { background: linear-gradient(135deg,#8E2DE2 0%,#4A00E0 100%); box-shadow:0 10px 20px rgba(74,0,224,0.3); }
        .cat-herbs { background: linear-gradient(135deg,#56ab2f 0%,#a8e063 100%); }
        .cat-spices { background: linear-gradient(135deg,#ff512f 0%,#dd2476 100%); }
        .cat-liquids { background: linear-gradient(135deg,#4facfe 0%,#00f2fe 100%); }
        .cat-oils { background: linear-gradient(135deg,#f09819 0%,#edde5d 100%); }
        .cat-grains { background: linear-gradient(135deg,#EB3349 0%,#F45C43 100%); }
        .cat-hygiene { background: linear-gradient(135deg,#11998e 0%,#38ef7d 100%); }
        .cat-food { background: linear-gradient(135deg,#FF8008 0%,#FFC837 100%); }
        .cat-misc { background: linear-gradient(135deg,#6190E8 0%,#A7BFE8 100%); }

        .tile-content { position: relative; z-index: 2; text-align: center; width:100%; }
        .tile-content i { font-size: 3rem; margin-bottom: 10px; color: #fff; filter: drop-shadow(0 4px 4px rgba(0,0,0,0.2)); }
        .tile-content h2 { font-family: 'Lalezar', cursive; margin:0; font-size:1.4rem; text-shadow:0 2px 5px rgba(0,0,0,0.2); }

        /* --- بخش‌های داخلی --- */
        .inner-section { display: none; margin-top: 20px; background-color: white; padding:25px; border-radius:25px; box-shadow:var(--shadow); }
        .back-btn { 
            background-color: #f0f2f5; color: #555; border:none; padding:10px 20px; 
            border-radius:15px; cursor:pointer; font-family:'Vazirmatn'; font-weight:700;
            margin-bottom:20px; display:inline-flex; align-items:center; gap:8px;
        }

        .product-list { list-style:none; padding:0; margin:0; }
        .product-item {
            display:grid; grid-template-columns:auto auto 1fr auto; gap:10px;
            align-items:center; padding:15px 10px; border-bottom:1px solid #f4f4f4;
            transition:background-color 0.2s; border-radius:12px; margin-bottom:5px;
        }
        .product-item.selected { background-color:var(--selected-bg); border:1px solid var(--primary-color); }
        .product-checkbox { width:24px; height:24px; accent-color:var(--primary-color); }
        
        .star-btn {
            background:none; border:none; cursor:pointer; font-size:1.2rem; color:#ccc;
            transition:all 0.3s ease; padding:5px;
        }
        .star-btn.active { color:var(--gold-color); animation: starPop 0.3s cubic-bezier(0.175,0.885,0.32,1.275); }
        @keyframes starPop { 0% { transform: scale(1); } 50% { transform: scale(1.5); } 100% { transform: scale(1); } }

        .quantity-input-container { display:none; align-items:center; gap:10px; }
        .product-item.selected .quantity-input-container { display:flex; }
        .quantity-input { width:50px; padding:5px; border:2px solid #dce6c5; border-radius:10px; text-align:center; font-weight:bold; color:var(--primary-color); }
        .delete-btn { color:#ff4757; background:#ffeef0; border-radius:10px; width:32px; height:32px; display:flex; align-items:center; justify-content:center; cursor:pointer; }

        .special-form { display:flex; flex-direction:column; gap:20px; }
        .form-control { width:100%; padding:15px; border:2px solid #eee; border-radius:15px; font-size:1rem; box-sizing:border-box; }
        .btn-submit-special { background:linear-gradient(135deg,#203a43,#2c5364); color:white; padding:15px; border:none; border-radius:15px; font-size:1.1rem; width:100%; cursor:pointer; }

        /* --- میکسر --- */
        .mixer-wrapper { display:flex; flex-direction:column; align-items:center; gap:20px; }
        .size-selector { display:flex; background:#eee; padding:5px; border-radius:50px; width:100%; max-width:350px; margin-bottom:10px; }
        .size-btn { flex:1; border:none; background:transparent; padding:10px; border-radius:40px; cursor:pointer; font-family:'Lalezar'; font-size:1rem; color:#666; transition:all 0.3s ease; }
        .size-btn.active { background:#fff; color:#8E2DE2; box-shadow:0 2px 10px rgba(0,0,0,0.1); transform:scale(1.05); }

        .supplements-shelf {
            display:grid; grid-template-columns:repeat(5,1fr); gap:8px;
            background:#8B5E3C; padding:15px 10px 25px 10px; border-radius:15px; width:100%; position:relative;
            box-shadow:inset 0 10px 20px rgba(0,0,0,0.4),0 5px 15px rgba(0,0,0,0.2);
            border-bottom:8px solid #5D3A1A;
        }
        .supplement-jar {
            background:linear-gradient(to right,rgba(255,255,255,0.8),rgba(255,255,255,0.5));
            border-radius:5px; height:55px; display:flex; flex-direction:column; align-items:center;
            cursor:grab; position:relative; box-shadow:0 5px 5px rgba(0,0,0,0.2);
            transition:transform 0.1s;
        }
        .supplement-jar:active { transform:scale(0.9); cursor:grabbing; }
        .jar-lid { width:70%; height:6px; background:#333; margin-top:-3px; border-radius:2px; }
        .jar-body { width:100%; height:100%; border-radius:5px; display:flex; align-items:center; justify-content:center; }
        .jar-body span { font-size:0.6rem; font-weight:bold; color:rgba(0,0,0,0.6); writing-mode:vertical-rl; transform:rotate(180deg); }

        .mixing-area { position:relative; width:100%; height:260px; display:flex; justify-content:center; align-items:flex-end; }
        .flask-container { position:relative; width:160px; height:220px; display:flex; flex-direction:column-reverse; align-items:center; }
        .flask-glass {
            position:relative; width:100%; height:100%; background:rgba(255,255,255,0.1);
            border:4px solid rgba(255,255,255,0.6); border-top:none; border-radius:0 0 20px 20px;
            clip-path:polygon(20% 0,80% 0,100% 100%,0% 100%); overflow:hidden; z-index:2; backdrop-filter:blur(2px);
            box-shadow:inset 0 -10px 20px rgba(255,255,255,0.3),0 10px 20px rgba(0,0,0,0.1);
        }
        .flask-neck {
            position:absolute; top:-35px; left:50%; transform:translateX(-50%); width:50px; height:40px;
            background:rgba(255,255,255,0.1); border:4px solid rgba(255,255,255,0.6); border-bottom:none; border-radius:5px 5px 0 0; z-index:1;
        }
        .powder-layer { width:100%; transition:height 0.4s cubic-bezier(0.4,2,0.55,0.44); border-top:1px solid rgba(255,255,255,0.2); }
        .particle { position:absolute; top:0; width:6px; height:6px; border-radius:50%; animation: fall 0.6s linear forwards; z-index:5; pointer-events:none; }
        @keyframes fall { 0% { transform: translateY(0) scale(1); opacity:1; } 100% { transform: translateY(150px) scale(0.5); opacity:0; } }
        .flask-stats {
            position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
            font-size:1.8rem; font-weight:bold; color:#333; text-shadow:0 0 10px rgba(255,255,255,0.8);
            z-index:10; pointer-events:none; font-family:'Lalezar', cursive;
            background:rgba(255,255,255,0.6); padding:5px 15px; border-radius:20px;
        }
        .completed-mixes { width:100%; border-top:2px dashed #ddd; padding-top:15px; margin-top:15px; }
        .mix-item { background:white; padding:10px; border-radius:12px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 5px rgba(0,0,0,0.05); }
        .delete-mix-btn { color:red; background:#ffeeee; border:none; padding:5px 10px; border-radius:8px; cursor:pointer; }
        
        .drag-ghost {
            position:fixed; pointer-events:none; z-index:9999; width:50px; height:50px;
            opacity:0.9; border-radius:50%; box-shadow:0 10px 20px rgba(0,0,0,0.3);
            display:none; align-items:center; justify-content:center; font-size:20px;
            color:white; font-weight:bold; border:2px solid white;
        }

        .whatsapp-fab {
            position:fixed; bottom:25px; left:25px; 
            background:linear-gradient(135deg,#25D366,#128C7E); color:white; width:65px; height:65px; border-radius:50%;
            display:flex; justify-content:center; align-items:center; font-size:2.5rem;
            box-shadow:0 10px 25px rgba(37,211,102,0.3); text-decoration:none;
            transform:scale(0); transition:all 0.4s; cursor:pointer; z-index:1000;
        }
        .whatsapp-fab.visible { transform:scale(1); }
        .cart-counter {
            position:absolute; top:0; right:0; background-color:#ff4757; color:white; border-radius:50%;
            width:24px; height:24px; font-size:0.8rem; font-weight:bold; display:flex; justify-content:center; align-items:center; border:2px solid white;
        }
        #loading { text-align:center; padding:40px; color:#888; }
    </style>
</head>
<body>

    <header class="header">
        <button class="menu-toggle-btn" aria-label="باز کردن منو" onclick="toggleMenu()"><i class="fa-solid fa-bars"></i></button>
        <i class="fa-solid fa-leaf header-bg-icon"></i>
        <h1>فروشگاه سنجد</h1>
        <p>طبیعت را به خانه خود بیاورید</p>
    </header>

    <div class="side-menu-overlay" id="menuOverlay" onclick="toggleMenu()"></div>
    <div class="side-menu" id="sideMenu">
        <div class="side-menu-header">
            <h3 style="margin:0; font-family:'Lalezar'; font-size:1.5rem; color:var(--gold-color)">علاقه‌مندی‌ها</h3>
            <button class="close-menu-btn" aria-label="بستن منو" onclick="toggleMenu()">×</button>
        </div>
        <div class="fav-list-container" id="favoritesList">
            <div style="text-align:center; color:rgba(255,255,255,0.6); margin-top:20px; font-size:0.9rem;">لیست خالی است</div>
        </div>
        <div style="text-align:center; font-size:0.8rem; color:rgba(255,255,255,0.4); padding-top:10px;">Senjed Store v2.1 (Hybrid)</div>
    </div>

    <div class="container">
        <div class="search-container">
            <i class="fa-solid fa-search search-icon"></i>
            <input type="search" id="search-input" placeholder="جستجو محصولات..." autocomplete="off">
        </div>

        <div id="category-view">
            <div class="categories-grid">
                <div class="category-tile cat-special" onclick="showSection('special-request-view')">
                    <div class="tile-content"><i class="fa-solid fa-star"></i><h2>سفارش محصول خاص</h2></div>
                </div>
                <div class="category-tile cat-mixer" onclick="initMixer(); showSection('mixer-view')">
                    <div class="tile-content"><i class="fa-solid fa-flask"></i><h2>میکس مکمل (دلخواه)</h2></div>
                </div>
                <!-- همه دسته‌های نسخه قدیمی -->
                <div class="category-tile cat-herbs" data-category="گیاهان-دارویی"><div class="tile-content"><i class="fa-solid fa-leaf"></i><h2>گیاهان دارویی</h2></div></div>
                <div class="category-tile cat-spices" data-category="ادویه-جات"><div class="tile-content"><i class="fa-solid fa-mortar-pestle"></i><h2>ادویه‌جات</h2></div></div>
                <div class="category-tile cat-liquids" data-category="عرقیات"><div class="tile-content"><i class="fa-solid fa-bottle-droplet"></i><h2>عرقیات</h2></div></div>
                <div class="category-tile cat-oils" data-category="روغن-ها"><div class="tile-content"><i class="fa-solid fa-oil-well"></i><h2>روغن‌ها</h2></div></div>
                <div class="category-tile cat-grains" data-category="حبوبات-و-غلات"><div class="tile-content"><i class="fa-solid fa-wheat-awn"></i><h2>حبوبات</h2></div></div>
                <div class="category-tile cat-hygiene" data-category="شوینده-و-بهداشتی"><div class="tile-content"><i class="fa-solid fa-pump-soap"></i><h2>بهداشتی</h2></div></div>
                <div class="category-tile cat-food" data-category="محصولات-خوراکی"><div class="tile-content"><i class="fa-solid fa-jar"></i><h2>خوراکی</h2></div></div>
                <div class="category-tile cat-misc" data-category="متفرقه"><div class="tile-content"><i class="fa-solid fa-box-open"></i><h2>سایر</h2></div></div>
            </div>
        </div>

        <div id="product-view" class="inner-section">
            <button class="back-btn" onclick="showCategoryView()"><i class="fa-solid fa-arrow-right"></i> بازگشت</button>
            <h2 id="product-category-title" style="color:var(--primary-color); font-family:'Lalezar';"></h2>
            <div id="loading">درحال بارگذاری...</div>
            <ul id="product-list" class="product-list"></ul>
        </div>

        <div id="special-request-view" class="inner-section">
            <button class="back-btn" onclick="showCategoryView()"><i class="fa-solid fa-arrow-right"></i> بازگشت</button>
            <h2 style="font-family:'Lalezar'; color:#203a43;">سفارش محصول کمیاب</h2>
            <div class="special-form">
                <input type="text" id="special-name" class="form-control" placeholder="نام محصول">
                <input type="text" id="special-details" class="form-control" placeholder="توضیحات و وزن (مثلا: ۵۰۰ گرم)">
                <button class="btn-submit-special" onclick="sendSpecialRequest()"><i class="fab fa-whatsapp"></i> ارسال به واتس‌اپ</button>
            </div>
        </div>

        <div id="mixer-view" class="inner-section" style="background:#fff9fc;">
            <button class="back-btn" onclick="showCategoryView()"><i class="fa-solid fa-arrow-right"></i> بازگشت</button>
            
            <div class="mixer-wrapper">
                <h2 style="font-family:'Lalezar'; color:#8E2DE2; margin:0;">آزمایشگاه مکمل</h2>
                
                <div class="size-selector">
                    <button class="size-btn" onclick="setMixerSize(500,50,this)">نیم کیلو</button>
                    <button class="size-btn active" onclick="setMixerSize(1000,100,this)">یک کیلو</button>
                    <button class="size-btn" onclick="setMixerSize(5000,250,this)">پنج کیلو</button>
                </div>

                <div class="supplements-shelf" id="shelf"></div>

                <div class="mixing-area">
                    <div class="flask-container" id="flask-target">
                        <div class="flask-neck"></div>
                        <div class="flask-glass" id="flask-content"></div>
                        <div class="flask-stats"><span id="current-weight">0</span>g</div>
                    </div>
                </div>

                <div class="completed-mixes">
                    <h4 style="margin:0 0 10px 0; color:#555;">ترکیب‌های آماده ارسال:</h4>
                    <div id="mix-list">
                        <small style="color:#999; display:block; text-align:center;">هنوز ترکیبی نساخته‌اید.</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="whatsapp-button" class="whatsapp-fab">
        <i class="fab fa-whatsapp"></i>
        <span id="cart-counter" class="cart-counter"></span>
    </div>

    <div id="drag-ghost" class="drag-ghost"></div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const whatsappNumber = "989918022066";
        const categoryView = document.getElementById('category-view');
        const productList = document.getElementById('product-list');
        const categoryTitle = document.getElementById('product-category-title');
        const loadingDiv = document.getElementById('loading');
        const whatsappBtn = document.getElementById('whatsapp-button');
        const cartCounter = document.getElementById('cart-counter');
        const searchInput = document.getElementById('search-input');
        const sideMenu = document.getElementById('sideMenu');
        const menuOverlay = document.getElementById('menuOverlay');
        const favoritesListEl = document.getElementById('favoritesList');

        // متغیر محصولات - ابتدا خالی
        let allProducts = [];

        // بکاپ محصولات (جدید - هماهنگ با لیست شما)
        const backupProducts = [
          {"name": "آرد برنج", "category": "حبوبات-و-غلات", "available": true, "unit": "گرم"},
          {"name": "آرد جو", "category": "حبوبات-و-غلات", "available": true, "unit": "گرم"},
          {"name": "آرد جوانه گندم", "category": "حبوبات-و-غلات", "available": true, "unit": "گرم"},
          {"name": "آرد گندم", "category": "حبوبات-و-غلات", "available": true, "unit": "گرم"},
          {"name": "آرد نخودچی", "category": "حبوبات-و-غلات", "available": true, "unit": "گرم"},
          {"name": "آویشن", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "آویشن شیرازی", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "اسپند", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "استخودوس", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "افتیمون", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "اکالیپتوس", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "انجیر خشک", "category": "محصولات-خوراکی", "available": true, "unit": "گرم"},
          {"name": "انیسون", "category": "ادویه-جات", "available": true, "unit": "گرم"},
          {"name": "بابا آدم", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "بابونه", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "بادرنجبویه", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "بارهنگ", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "برگ بو", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "برگ سنا", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "برگ گردو", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "برنج ایرانی", "category": "حبوبات-و-غلات", "available": true, "unit": "کیلو"},
          {"name": "بومادران", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "به لیمو", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "بهار نارنج", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "پاپایا", "category": "ادویه-جات", "available": true, "unit": "گرم"},
          {"name": "پاپل", "category": "متفرقه", "available": false, "unit": "عدد"},
          {"name": "پودر پاپریکا", "category": "ادویه-جات", "available": true, "unit": "گرم"},
          {"name": "پودر پیاز", "category": "ادویه-جات", "available": true, "unit": "گرم"},
          {"name": "پودر دارچین", "category": "ادویه-جات", "available": true, "unit": "گرم"},
          {"name": "پودر زنجبیل", "category": "ادویه-جات", "available": true, "unit": "گرم"},
          {"name": "پودر سیر", "category": "ادویه-جات", "available": true, "unit": "گرم"},
          {"name": "پودر لیمو", "category": "ادویه-جات", "available": true, "unit": "گرم"},
          {"name": "پودر نارگیل", "category": "محصولات-خوراکی", "available": true, "unit": "گرم"},
          {"name": "پونه", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "پونه کوهی", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "تاج ریزی", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "تخم بالنگا", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "تخم خرفه", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "تخم ریحان", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "تخم شربتی", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "تخم شوید", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "تخم کاهو", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "تخم کتان", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "تخم گشنیز", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "ترنجبین", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "جدوا", "category": "ادویه-جات", "available": true, "unit": "گرم"},
          {"name": "جو دوسر پرک", "category": "حبوبات-و-غلات", "available": true, "unit": "گرم"},
          {"name": "جوز هندی", "category": "ادویه-جات", "available": true, "unit": "عدد"},
          {"name": "جوهر لیمو", "category": "متفرقه", "available": true, "unit": "گرم"},
          {"name": "چای ترش", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "چای سبز", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "چای کوهی", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "چای ماسالا", "category": "محصولات-خوراکی", "available": true, "unit": "گرم"},
          {"name": "چوب دارچین", "category": "ادویه-جات", "available": true, "unit": "گرم"},
          {"name": "چهار تخم", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "چهارگل", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "حنا", "category": "شوینده-و-بهداشتی", "available": true, "unit": "گرم"},
          {"name": "خاکشیر", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "ختمی", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "خردل", "category": "ادویه-جات", "available": true, "unit": "گرم"},
          {"name": "دار فلفل", "category": "ادویه-جات", "available": true, "unit": "گرم"},
          {"name": "دارچین", "category": "ادویه-جات", "available": true, "unit": "گرم"},
          {"name": "رازیانه", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "رزماری", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "روغن آرگان", "category": "روغن-ها", "available": true, "unit": "عدد"},
          {"name": "روغن بادام تلخ", "category": "روغن-ها", "available": true, "unit": "عدد"},
          {"name": "روغن بادام شیرین", "category": "روغن-ها", "available": true, "unit": "عدد"},
          {"name": "روغن بنفشه", "category": "روغن-ها", "available": true, "unit": "عدد"},
          {"name": "روغن خراطین", "category": "روغن-ها", "available": true, "unit": "عدد"},
          {"name": "روغن زیتون", "category": "روغن-ها", "available": true, "unit": "عدد"},
          {"name": "روغن سیاهدانه", "category": "روغن-ها", "available": true, "unit": "عدد"},
          {"name": "روغن کرچک", "category": "روغن-ها", "available": true, "unit": "عدد"},
          {"name": "روغن کنجد", "category": "روغن-ها", "available": true, "unit": "عدد"},
          {"name": "روغن مورد", "category": "روغن-ها", "available": true, "unit": "عدد"},
          {"name": "روغن نارگیل", "category": "روغن-ها", "available": true, "unit": "عدد"},
          {"name": "زردچوبه", "category": "ادویه-جات", "available": true, "unit": "گرم"},
          {"name": "زعفران", "category": "ادویه-جات", "available": true, "unit": "گرم"},
          {"name": "زنجبیل", "category": "ادویه-جات", "available": true, "unit": "گرم"},
          {"name": "زنیان", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "زیره سبز", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "زیره سیاه", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "سدر", "category": "شوینده-و-بهداشتی", "available": true, "unit": "گرم"},
          {"name": "سرکه سیب", "category": "محصولات-خوراکی", "available": true, "unit": "بطری"},
          {"name": "سماق", "category": "ادویه-جات", "available": true, "unit": "گرم"},
          {"name": "سمنو", "category": "شیرین", "available": false, "unit": "گرم"},
          {"name": "سنجد", "category": "محصولات-خوراکی", "available": true, "unit": "گرم"},
          {"name": "سیاهدانه", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "شاتره", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "شاهسفرم", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "شکر سرخ", "category": "محصولات-خوراکی", "available": true, "unit": "گرم"},
          {"name": "شکر قهوه ای", "category": "محصولات-خوراکی", "available": true, "unit": "گرم"},
          {"name": "شنبلیله", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "شیر خشت", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "شیره انگور", "category": "محصولات-خوراکی", "available": true, "unit": "ظرف"},
          {"name": "شیره توت", "category": "محصولات-خوراکی", "available": true, "unit": "ظرف"},
          {"name": "شیره خرما", "category": "محصولات-خوراکی", "available": true, "unit": "ظرف"},
          {"name": "شیرین بیان", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "صابون", "category": "شوینده-و-بهداشتی", "available": true, "unit": "عدد"},
          {"name": "صابون زردچوبه", "category": "شوینده-و-بهداشتی", "available": true, "unit": "عدد"},
          {"name": "صمغ عربی", "category": "شوینده-و-بهداشتی", "available": true, "unit": "گرم"},
          {"name": "عرق آلوورا", "category": "عرقیات", "available": true, "unit": "بطری"},
          {"name": "عرق آویشن", "category": "عرقیات", "available": true, "unit": "بطری"},
          {"name": "عرق اترج", "category": "عرقیات", "available": true, "unit": "بطری"},
          {"name": "عرق اسطوخودوس", "category": "عرقیات", "available": true, "unit": "بطری"},
          {"name": "عرق بادرنجبویه", "category": "عرقیات", "available": true, "unit": "بطری"},
          {"name": "عرق بارهنگ", "category": "عرقیات", "available": true, "unit": "بطری"},
          {"name": "عرق برگ چنار", "category": "عرقیات", "available": true, "unit": "بطری"},
          {"name": "عرق برگ زیتون", "category": "عرقیات", "available": true, "unit": "بطری"},
          {"name": "عرق برگ گردو", "category": "عرقیات", "available": true, "unit": "بطری"},
          {"name": "عرق بومادران", "category": "عرقیات", "available": true, "unit": "بطری"},
          {"name": "عرق بهارنارنج", "category": "عرقیات", "available": true, "unit": "بطری"},
          {"name": "عرق بید", "category": "عرقیات", "available": true, "unit": "بطری"},
          {"name": "عرق بیدمشک", "category": "عرقیات", "available": true, "unit": "بطری"},
          {"name": "عرق پونه", "category": "عرقیات", "available": true, "unit": "بطری"},
          {"name": "عرق خارخاسک", "category": "عرقیات", "available": true, "unit": "بطری"},
          {"name": "عرق خارشتر", "category": "عرقیات", "available": true, "unit": "بطری"},
          {"name": "عرق ختمی", "category": "عرقیات", "available": true, "unit": "بطری"},
          {"name": "عرق رازیانه", "category": "عرقیات", "available": true, "unit": "بطری"},
          {"name": "عرق زنیان", "category": "عرقیات", "available": true, "unit": "بطری"},
          {"name": "عرق زیره", "category": "عرقیات", "available": true, "unit": "بطری"},
          {"name": "عرق سنبل الطیب", "category": "عرقیات", "available": true, "unit": "بطری"},
          {"name": "عرق شاتره", "category": "عرقیات", "available": true, "unit": "بطری"},
          {"name": "عرق شنبلیله", "category": "عرقیات", "available": true, "unit": "بطری"},
          {"name": "عرق شوید", "category": "عرقیات", "available": true, "unit": "بطری"},
          {"name": "عرق شیرین بیان", "category": "عرقیات", "available": true, "unit": "بطری"},
          {"name": "عرق کاسنی", "category": "عرقیات", "available": true, "unit": "بطری"},
          {"name": "عرق کرفس", "category": "عرقیات", "available": true, "unit": "بطری"},
          {"name": "عرق کیالک", "category": "عرقیات", "available": true, "unit": "بطری"},
          {"name": "عرق گزنه", "category": "عرقیات", "available": true, "unit": "بطری"},
          {"name": "عرق گشنیز", "category": "عرقیات", "available": true, "unit": "بطری"},
          {"name": "عرق گلاب", "category": "عرقیات", "available": true, "unit": "بطری"},
          {"name": "عرق مرزه", "category": "عرقیات", "available": true, "unit": "بطری"},
          {"name": "عرق نعنا", "category": "عرقیات", "available": true, "unit": "بطری"},
          {"name": "عرق هل", "category": "عرقیات", "available": true, "unit": "بطری"},
          {"name": "عرق یونجه", "category": "عرقیات", "available": true, "unit": "بطری"},
          {"name": "عسل", "category": "محصولات-خوراکی", "available": true, "unit": "ظرف"},
          {"name": "عناب", "category": "محصولات-خوراکی", "available": true, "unit": "گرم"},
          {"name": "غنچه گل محمدی", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "فلفل سیاه", "category": "ادویه-جات", "available": true, "unit": "گرم"},
          {"name": "فلفل قرمز", "category": "ادویه-جات", "available": true, "unit": "گرم"},
          {"name": "فلوس", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "فیبر", "category": "متفرقه", "available": true, "unit": "عدد"},
          {"name": "قدومه", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "کتیرا", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "کنجد", "category": "حبوبات-و-غلات", "available": true, "unit": "گرم"},
          {"name": "کندر", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "گل بابونه", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "گل بنفشه", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "گل پنیرک", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "گل ختمی", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "گل زوفا", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "گل محمدی", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "گلرنگ", "category": "ادویه-جات", "available": true, "unit": "گرم"},
          {"name": "گلنار", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "گندم", "category": "حبوبات-و-غلات", "available": true, "unit": "کیلو"},
          {"name": "ماریانا", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "مازو", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "مخلصه", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "مرزنجوش", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "مریم گلی", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "موسیر", "category": "ادویه-جات", "available": true, "unit": "گرم"},
          {"name": "میخک", "category": "ادویه-جات", "available": true, "unit": "گرم"},
          {"name": "نشاسته", "category": "محصولات-خوراکی", "available": true, "unit": "گرم"},
          {"name": "نعنا", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "نعنا خشک", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"},
          {"name": "نمک دریا", "category": "محصولات-خوراکی", "available": true, "unit": "گرم"},
          {"name": "وایتکس", "category": "شوینده-و-بهداشتی", "available": true, "unit": "عدد"},
          {"name": "هل", "category": "ادویه-جات", "available": true, "unit": "گرم"},
          {"name": "هلیله", "category": "گیاهان-دارویی", "available": true, "unit": "گرم"}
        ];

        // تلاش برای خواندن فایل products.json
        fetch('products.json')
            .then(response => {
                if (!response.ok) throw new Error("File not found or CORS error");
                return response.json();
            })
            .then(data => {
                console.log("محصولات با موفقیت از فایل خارجی بارگذاری شدند.");
                allProducts = data;
            })
            .catch(error => {
                console.warn("خطا در بارگذاری فایل محصولات. استفاده از داده‌های پشتیبان.", error);
                // اگر فایل جیسون نبود، از بکاپ استفاده کن تا برنامه خراب نشود
                allProducts = backupProducts;
            });


        let shoppingCart = [];
        let mixedProducts = [];
        let favorites = JSON.parse(localStorage.getItem('senjedFavorites')) || [];

        function slugify(text) {
            return text.toString().toLowerCase()
              .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
              .replace(/[^a-z0-9، ]/g, '')
              .replace(/\s+/g, '-');
        }

        window.toggleMenu = function() {
            sideMenu.classList.toggle('active');
            menuOverlay.classList.toggle('active');
            updateFavoritesMenu();
        }

        window.toggleFavorite = function(productName, event) {
            event.stopPropagation();
            const idx = favorites.indexOf(productName);
            if (idx === -1) favorites.push(productName);
            else favorites.splice(idx, 1);
            localStorage.setItem('senjedFavorites', JSON.stringify(favorites));

            const btn = document.querySelector(`.star-btn[data-fav-name="${productName}"]`);
            if (btn) {
                btn.classList.toggle('active');
                const icon = btn.querySelector('i');
                if (btn.classList.contains('active')) {
                    icon.classList.replace('fa-regular','fa-solid');
                } else {
                    icon.classList.replace('fa-solid','fa-regular');
                }
            }
            updateFavoritesMenu();
        }

        function updateFavoritesMenu() {
            favoritesListEl.innerHTML = '';
            if (favorites.length === 0) {
                favoritesListEl.innerHTML = '<div style="text-align:center; color:rgba(255,255,255,0.6); margin-top:20px; font-size:0.9rem;">لیست خالی است</div>';
                return;
            }
            favorites.forEach(name => {
                const div = document.createElement('div');
                div.className = 'fav-item';
                div.innerHTML = `
                    <span>${name}</span>
                    <i class="fa-solid fa-trash" aria-label="حذف از علاقه‌مندی" onclick="toggleFavorite('${name}', event)"></i>
                `;
                favoritesListEl.appendChild(div);
            });
        }

        window.showCategoryView = function() {
            document.querySelectorAll('.inner-section').forEach(el => el.style.display='none');
            categoryView.style.display='block';
            window.scrollTo(0,0);
        }

        window.showSection = function(id) {
            categoryView.style.display='none';
            document.querySelectorAll('.inner-section').forEach(el => el.style.display='none');
            document.getElementById(id).style.display='block';
            window.scrollTo(0,0);
        }

        function updateCartAndButton() {
            const standardItems = [];
            document.querySelectorAll('.product-checkbox:checked').forEach(checkbox => {
                const li = checkbox.closest('.product-item');
                const name = checkbox.dataset.name;
                const unit = checkbox.dataset.unit;
                const qInput = li.querySelector('.quantity-input');
                standardItems.push({ name, quantity: qInput.value||1, unit, type:'standard' });
            });
            shoppingCart = [...standardItems, ...mixedProducts];
            if (shoppingCart.length > 0) {
                whatsappBtn.classList.add('visible');
                cartCounter.textContent = shoppingCart.length;
            } else {
                whatsappBtn.classList.remove('visible');
            }
        }

        function renderProductList(products, title) {
            productList.innerHTML='';
            categoryTitle.textContent=title;
            loadingDiv.style.display='none';
            if (products.length===0) {
                productList.innerHTML='<li style="text-align:center; color:#777; padding:20px;">محصولی یافت نشد.</li>';
                return;
            }
            products.sort((a,b)=>a.name.localeCompare(b.name,'fa'));
            products.forEach(p=>{
                const slug = slugify(p.name);
                const inCart = shoppingCart.find(i=>i.name===p.name && i.type==='standard');
                const isSel = !!inCart;
                const isFav = favorites.includes(p.name);
                const starClass = isFav?'active':'';
                const starIcon = isFav?'fa-solid':'fa-regular';

                const li = document.createElement('li');
                li.className='product-item'+(isSel?' selected':'');

                if (p.available) {
                    li.innerHTML = `
                        <button class="star-btn ${starClass}" aria-label="علاقه‌مندی" data-fav-name="${p.name}" onclick="toggleFavorite('${p.name}', event)">
                            <i class="${starIcon} fa-star"></i>
                        </button>
                        <input type="checkbox" id="prod-${slug}" class="product-checkbox" data-name="${p.name}" data-unit="${p.unit||'عدد'}" ${isSel?'checked':''}>
                        <label for="prod-${slug}" class="product-name">${p.name}</label>
                        <div class="quantity-input-container">
                            <input type="number" min="1" class="quantity-input" value="${inCart?inCart.quantity:1}">
                            <span style="font-size:0.8rem; color:#888;">${p.unit||'عدد'}</span>
                            <div class="delete-btn" aria-label="حذف محصول"><i class="fa-solid fa-trash-can"></i></div>
                        </div>
                    `;
                } else {
                    li.innerHTML = `<span class="product-name" style="text-decoration:line-through; color:#aaa;">${p.name}</span><span class="status-badge" style="background:#fff0f0; color:red;">ناموجود</span>`;
                }
                productList.appendChild(li);
            });
        }

        productList.addEventListener('change', e=>{
            if (e.target.classList.contains('product-checkbox')) {
                const li = e.target.closest('.product-item');
                if (e.target.checked) {
                    li.classList.add('selected');
                    setTimeout(()=>li.querySelector('.quantity-input').focus(),50);
                } else {
                    li.classList.remove('selected');
                }
                updateCartAndButton();
            }
        });
        
        productList.addEventListener('click', e=>{
            if (e.target.closest('.delete-btn')) {
                if(!confirm('آیا مطمئن هستید که می‌خواهید این محصول را از سبد خرید حذف کنید؟')) return;
                const li = e.target.closest('.product-item');
                const cb = li.querySelector('.product-checkbox');
                cb.checked=false;
                li.classList.remove('selected');
                updateCartAndButton();
            }
        });
        productList.addEventListener('input', e=>{ if(e.target.classList.contains('quantity-input')) updateCartAndButton(); });

        document.querySelectorAll('.category-tile[data-category]').forEach(tile=>{
            tile.addEventListener('click', function(){
                const cat = this.dataset.category;
                const name = this.querySelector('h2').textContent;
                renderProductList(allProducts.filter(p=>p.category===cat), name);
                showSection('product-view');
            });
        });

        // جستجو
        let searchTimeout;
        searchInput.addEventListener('input', ()=>{
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(()=>{
                const term = searchInput.value.trim().toLowerCase();
                if (term) {
                    categoryView.style.display='none';
                    document.querySelectorAll('.inner-section').forEach(el=>el.style.display='none');
                    document.getElementById('product-view').style.display='block';
                    renderProductList(allProducts.filter(p=>p.name.toLowerCase().includes(term)), `نتایج: «${term}»`);
                } else {
                    showCategoryView();
                }
            },300);
        });

        whatsappBtn.addEventListener('click', ()=>{
            updateCartAndButton();
            if (shoppingCart.length===0) return;
            let msg = "سلام فروشگاه سنجد، سفارش من:\n\n";
            const std = shoppingCart.filter(i=>i.type==='standard');
            if(std.length){
                msg+="📦 محصولات:\n";
                std.forEach(i=>msg+=`▪️ ${i.name}: ${i.quantity} ${i.unit}\n`);
            }
            const mix = shoppingCart.filter(i=>i.type==='mix');
            if(mix.length){
                msg+="\n🧪 ترکیب‌های اختصاصی:\n";
                mix.forEach(i=>msg+=`▪️ ${i.name} (${i.quantity} ظرف)\n   (وزن: ${i.weightLabel})\n   محتویات: ${i.details}\n`);
            }
            window.open(`https://wa.me/${whatsappNumber}?text=${encodeURIComponent(msg)}`,'_blank');
        });

        window.sendSpecialRequest = function(){
            const n = document.getElementById('special-name').value;
            const d = document.getElementById('special-details').value;
            if(!n) return alert('نام محصول الزامی است');
            window.open(`https://wa.me/${whatsappNumber}?text=${encodeURIComponent(`درخواست خاص:\nمحصول: ${n}\nتوضیحات: ${d}`)}`,'_blank');
        }

        // --- کد میکسر ---
        let mixerConfig = { max:1000, step:100 }, currentFlaskWeight = 0, flaskIngredients = [], mixCounter = 1;
        const jarColors = ['#FF6B6B','#4ECDC4','#FFE66D','#FF9F43','#54A0FF','#5F27CD','#C4E538','#FDA7DF','#D980FA','#B53471','#009432','#F79F1F','#1B1464','#EA2027','#A3CB38','#12CBC4','#ED4C67','#B53471','#833471','#6F1E51'];
        
        window.setMixerSize = function(max,step,btn){
            if(currentFlaskWeight>0 && !confirm("با تغییر سایز، محتویات فعلی ظرف خالی می‌شود. ادامه دهید؟")) return;
            resetFlask();
            mixerConfig={max,step};
            document.querySelectorAll('.size-btn').forEach(b=>b.classList.remove('active'));
            btn.classList.add('active');
        }
        function resetFlask(){
            currentFlaskWeight=0; flaskIngredients=[];
            document.getElementById('flask-content').innerHTML='';
            document.getElementById('current-weight').textContent='0';
        }
        window.initMixer = function(){
            const shelf = document.getElementById('shelf');
            if(shelf.children.length>0) return;
            jarColors.forEach((color,i)=>{
                const div = document.createElement('div');
                div.className='supplement-jar';
                div.setAttribute('data-name',`مکمل ${i+1}`);
                div.setAttribute('data-color',color);
                div.innerHTML=`<div class="jar-lid"></div><div class="jar-body" style="background:${color}"><span style="color:#fff">مکمل ${i+1}</span></div>`;
                div.draggable=true;
                div.addEventListener('dragstart',handleDragStart);
                div.addEventListener('touchstart',handleTouchStart,{passive:false});
                div.addEventListener('touchmove',handleTouchMove,{passive:false});
                div.addEventListener('touchend',handleTouchEnd);
                shelf.appendChild(div);
            });
            const target = document.getElementById('flask-target');
            target.addEventListener('dragover',e=>e.preventDefault());
            target.addEventListener('drop',handleDrop);
        }
        let draggedData=null, ghost=document.getElementById('drag-ghost');
        function handleDragStart(){ draggedData={name:this.dataset.name,color:this.dataset.color}; }
        function handleDrop(e){ e.preventDefault(); if(draggedData) addIngredient(draggedData); }
        function handleTouchStart(e){
            e.preventDefault();
            const t=e.touches[0];
            draggedData={name:this.dataset.name,color:this.dataset.color};
            ghost.style.display='flex';
            ghost.style.background=draggedData.color;
            ghost.innerHTML='<i class="fa-solid fa-cube"></i>';
            moveGhost(t.clientX,t.clientY);
        }
        function handleTouchMove(e){ e.preventDefault(); moveGhost(e.touches[0].clientX,e.touches[0].clientY); }
        function handleTouchEnd(e){
            ghost.style.display='none';
            const t=e.changedTouches[0];
            const rect=document.getElementById('flask-target').getBoundingClientRect();
            if(t.clientX>=rect.left&&t.clientX<=rect.right&&t.clientY>=rect.top&&t.clientY<=rect.bottom){
                if(draggedData) addIngredient(draggedData);
            }
            draggedData=null;
        }
        function moveGhost(x,y){ ghost.style.left=(x-25)+'px'; ghost.style.top=(y-25)+'px'; }

        function addIngredient(item){
            if(currentFlaskWeight>=mixerConfig.max){ alert("ظرف پر شده است!"); return; }
            currentFlaskWeight+=mixerConfig.step;
            document.getElementById('current-weight').textContent=currentFlaskWeight;
            const layer=document.createElement('div');
            layer.className='powder-layer';
            layer.style.height=((mixerConfig.step/mixerConfig.max)*100)+'%';
            layer.style.backgroundColor=item.color;
            document.getElementById('flask-content').appendChild(layer);
            createParticles(item.color);
            flaskIngredients.push(item.name);
            if(currentFlaskWeight>=mixerConfig.max) setTimeout(finishMixing,600);
        }

        function createParticles(color){
            const flask=document.getElementById('flask-target');
            for(let i=0;i<5;i++){
                const p=document.createElement('div');
                p.className='particle';
                p.style.backgroundColor=color;
                p.style.left=(40+Math.random()*20)+'%';
                p.style.animationDuration=(0.5+Math.random()*0.5)+'s';
                flask.appendChild(p);
                setTimeout(()=>p.remove(),1000);
            }
        }

        function finishMixing(){
            const mixId=Date.now(), counts={};
            flaskIngredients.forEach(x=>counts[x]= (counts[x]||0)+1);
            const details = Object.entries(counts).map(([k,v])=>`${k} (${v*mixerConfig.step}g)`).join('، ');
            const weightLabel = mixerConfig.max>=1000?`${mixerConfig.max/1000} کیلوگرم`:`${mixerConfig.max} گرم`;
            const mixName = `میکس اختصاصی ${mixCounter} (${weightLabel})`;
            const newMix = { id:mixId, name:mixName, quantity:1, unit:"عدد", weightLabel, type:"mix", details };
            mixedProducts.push(newMix);
            const list=document.getElementById('mix-list');
            if(mixCounter===1) list.innerHTML='';
            const row=document.createElement('div');
            row.className='mix-item'; row.id=`mix-row-${mixId}`;
            row.innerHTML=`
                <div>
                    <span style="font-weight:bold; display:block;">${mixName}</span>
                    <span style="font-size:0.7rem; color:#777;">${details.substring(0,30)}...</span>
                </div>
                <button class="delete-mix-btn" aria-label="حذف ترکیب" onclick="removeMix(${mixId})">
                    <i class="fa-solid fa-trash"></i>
                </button>
            `;
            list.appendChild(row);
            mixCounter++;
            alert(`"${mixName}" ساخته شد و به سبد خرید اضافه گردید.`);
            resetFlask();
            updateCartAndButton();
        }

        window.removeMix = function(id){
            if(!confirm("این ترکیب حذف شود؟")) return;
            mixedProducts = mixedProducts.filter(p=>p.id!==id);
            const row=document.getElementById(`mix-row-${id}`);
            if(row) row.remove();
            if(mixedProducts.length===0){
                document.getElementById('mix-list').innerHTML = '<small style="color:#999; display:block; text-align:center;">هنوز ترکیبی نساخته‌اید.</small>';
                mixCounter=1;
            }
            updateCartAndButton();
        }
    });
    </script>
</body>
</html>
